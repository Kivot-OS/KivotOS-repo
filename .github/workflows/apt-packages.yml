name: apt-packages
on:
  workflow_dispatch:
  push:
    paths:
      - 'packages.json'
      - '.github/workflows/apt-packages.yml'
  schedule:
    - cron: "0 3 1 * *"

concurrency:
  group: apt-publish
  cancel-in-progress: false

env:
  COMPONENT: main
  PAGES_DIR: docs/apt

jobs:
  matrix:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.read.outputs.packages }}
      distros:  ${{ steps.read.outputs.distros }}
    steps:
      - uses: actions/checkout@v4
      - id: read
        run: |
          set -euo pipefail
          if [ ! -f packages.json ]; then
            echo '{"distros":["trixie"],"packages":[]}' > packages.json
          fi
          echo "packages=$(jq -c '.packages' packages.json)" >> "$GITHUB_OUTPUT"
          echo "distros=$(jq -r '.distros|join(" ")' packages.json)" >> "$GITHUB_OUTPUT"

  build:
    name: build ${{ matrix.name }}
    needs: matrix
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.matrix.outputs.packages) }}
    steps:
      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git dpkg-dev build-essential cmake pkg-config
          if [ "${{ matrix.type }}" = "cargo" ]; then
            sudo apt-get install -y rustc cargo
            cargo install cargo-deb --locked
          fi

      - name: Build/Fetch
        shell: bash
        env:
          CRATES: ${{ toJson(matrix.crates) }}
        run: |
          set -euo pipefail
          ART="${GITHUB_WORKSPACE}/artifacts"
          mkdir -p "$ART"

          case "${{ matrix.type }}" in
            cargo)
              TAG=$(curl -fsSL "https://api.github.com/repos/${{ matrix.repo }}/releases/latest" | jq -r .tag_name)
              curl -fsSL -o src.tgz "https://github.com/${{ matrix.repo }}/archive/refs/tags/${TAG}.tar.gz"
              tar -xzf src.tgz
              pushd "$(basename "${{ matrix.repo }}")-${TAG#v}"
              if [ "${CRATES}" != "null" ]; then
                echo "$CRATES" | jq -r '.[]' | while read -r C; do cargo deb -p "$C" --locked; done
              else
                cargo deb --locked
              fi
              mv target/debian/*.deb "$ART"
              popd
              ;;

            make)
              NAME="${{ matrix.name }}"
              REPO="${{ matrix.repo }}"
              DESC="${{ matrix.description }}"; : "${DESC:=Package built by KivotOS CI}"
              BINARY="${{ matrix.binary }}";     : "${BINARY:=hellwal}"

              TAG=$(curl -fsSL "https://api.github.com/repos/${REPO}/releases/latest" | jq -r .tag_name 2>/dev/null || true)
              if [ -n "$TAG" ] && [ "$TAG" != "null" ]; then
                curl -fsSL -o src.tgz "https://github.com/${REPO}/archive/refs/tags/${TAG}.tar.gz"
                tar -xzf src.tgz; SRC_DIR="$(basename "$REPO")-${TAG#v}"; VER=${TAG#v}
              else
                git clone --depth=1 "https://github.com/${REPO}" src; SRC_DIR=src; VER="0.0+git$(date -u +%Y%m%d)"
              fi
              pushd "$SRC_DIR"
              make
              mkdir -p pkg/DEBIAN pkg/usr/bin "pkg/usr/share/doc/${NAME}"
              install -Dm755 "$BINARY" "pkg/usr/bin/${NAME}" || install -Dm755 "${NAME}" "pkg/usr/bin/${NAME}"
              [ -f README.md ] && install -Dm644 README.md "pkg/usr/share/doc/${NAME}/README.md" || true
              printf '%s\n' \
                "Package: ${NAME}" \
                "Version: ${VER}-1" \
                "Section: utils" \
                "Priority: optional" \
                "Architecture: amd64" \
                "Maintainer: KivotOS <maintainers@kivotos.local>" \
                "Homepage: https://github.com/${REPO}" \
                "Description: ${DESC}" > pkg/DEBIAN/control
              dpkg-deb -Zxz --uniform-compression --build pkg "${NAME}_${VER}-1_amd64.deb"
              mv "${NAME}_${VER}-1_amd64.deb" "$ART"
              popd
              ;;

            mirror)
              API="https://api.github.com/repos/${{ matrix.repo }}/releases/latest"
              curl -fsSL "$API" | jq -r '.assets[] | .browser_download_url' \
                | grep -E "${{ matrix.pattern }}" \
                | while read -r URL; do FN=$(basename "$URL"); curl -L "$URL" -o "$ART/$FN"; done
              ;;
            *) echo "Unknown type: ${{ matrix.type }}"; exit 1;;
          esac

          ls -lh "$ART"

      - uses: actions/upload-artifact@v4
        with:
          name: debs-${{ matrix.name }}
          path: artifacts/*.deb
          retention-days: 1

  publish:
    name: publish to apt
    needs: [matrix, build]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update 
          sudo apt-get install -y aptly

      - name: Download all debs
        uses: actions/download-artifact@v4
        with:
          pattern: debs-*
          path: all-artifacts

      - name: Cache aptly DB
        uses: actions/cache@v4
        with:
          path: .aptly
          key: aptly-db-v1
          restore-keys: |
            aptly-db-
      - name: Configure GPG (loopback)
        run: |
          mkdir -p ~/.gnupg && chmod 700 ~/.gnupg
          printf 'pinentry-mode loopback\nbatch\n' > ~/.gnupg/gpg.conf
          printf 'allow-loopback-pinentry\n' > ~/.gnupg/gpg-agent.conf
          gpgconf --kill gpg-agent || true

      - name: Publish to APT
        env:
          DISTROS: ${{ needs.matrix.outputs.distros }}
          COMPONENT: ${{ env.COMPONENT }}
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE:  ${{ secrets.GPG_PASSPHRASE }}
        run: |
          set -euo pipefail
          
          # Clean and setup directories
          rm -rf docs/apt
          mkdir -p docs/apt
          
          # Configure aptly
          cat > ~/.aptly.conf <<'JSON'
          {
            "rootDir": ".aptly",
            "downloadConcurrency": 4,
            "FileSystemPublishEndpoints": {
              "docs/apt": {
                "rootDir": "docs/apt",
                "linkMethod": "copy"
              }
            }
          }
          JSON

          # Import GPG key
          echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --import
          KEYID=$(gpg --list-keys --with-colons | awk -F: '/^pub/{print $5; exit}')

          # Create and populate repo
          REPO_NAME="kivotos"
          aptly repo create -component="$COMPONENT" "$REPO_NAME" || true
          
          # Add all debs to repo
          find all-artifacts -name "*.deb" -exec aptly repo add -force-replace "$REPO_NAME" {} +

          # Publish for each distro
          for distro in $DISTROS; do
            # Drop old publication if exists
            aptly publish drop "$distro" filesystem:docs/apt: || true
            
            # Publish repo to docs/apt/
            aptly publish repo \
              -distribution="$distro" \
              -architectures=amd64 \
              -gpg-key="$KEYID" \
              -passphrase="$GPG_PASSPHRASE" \
              "$REPO_NAME" filesystem:docs/apt:
          done

          # Export public key to both locations
          gpg --armor --export "$KEYID" > docs/apt/pubkey.gpg
          gpg --armor --export "$KEYID" > docs/pubkey.gpg
          
          # Mark as non-Jekyll site
          touch docs/.nojekyll

      - name: Generate Debian-style directory indexes
        run: |
          # Function to generate index.html for a directory
          generate_index() {
            local dir="$1"
            local url_path="${dir#docs}"
            
            cat > "${dir}/index.html" <<EOF
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Index of /KivotOS-repo${url_path}/</title>
  <style>
    body { 
      font-family: monospace; 
      background: #fff; 
      color: #000; 
      margin: 0; 
      padding: 8px;
    }
    h1 { 
      font-size: 1.2em; 
    }
    pre {
      margin: 0;
    }
    a { 
      color: #0000ee; 
      text-decoration: none;
    }
    a:visited { 
      color: #551a8b;
    }
    a:hover { 
      text-decoration: underline;
    }
    hr {
      border: none;
      border-top: 1px solid #888;
    }
  </style>
</head>
<body>
<h1>Index of /KivotOS-repo${url_path}/</h1>
<hr>
<pre>
EOF
            
            # Parent directory link
            if [ "$dir" != "docs/apt" ]; then
              printf "%-50s %19s %s\n" "<a href=\"../\">../</a>" "-" "-" >> "${dir}/index.html"
            fi
            
            # List directories first
            for item in "$dir"/*/; do
              [ -d "$item" ] || continue
              name=$(basename "$item")
              [ "$name" = "*" ] && continue
              mtime=$(stat -c '%Y' "$item" 2>/dev/null || stat -f '%m' "$item" 2>/dev/null || echo 0)
              if [ "$mtime" -ne 0 ]; then
                date_str=$(date -d "@$mtime" '+%d-%b-%Y %H:%M' 2>/dev/null || date -r "$mtime" '+%d-%b-%Y %H:%M' 2>/dev/null || echo "-")
              else
                date_str="-"
              fi
              printf "%-50s %19s %s\n" "<a href=\"${name}/\">${name}/</a>" "-" "$date_str" >> "${dir}/index.html"
            done
            
            # Then list files
            for item in "$dir"/*; do
              [ -f "$item" ] || continue
              name=$(basename "$item")
              [ "$name" = "index.html" ] && continue
              
              size_bytes=$(stat -c '%s' "$item" 2>/dev/null || stat -f '%z' "$item" 2>/dev/null || echo 0)
              if [ $size_bytes -eq 0 ]; then
                size="-"
              elif [ $size_bytes -lt 1024 ]; then
                size="${size_bytes}"
              elif [ $size_bytes -lt 1048576 ]; then
                size="$(( size_bytes / 1024 ))K"
              else
                size="$((size_bytes / 1048576 )).$((size_bytes % 1048576 * 10 / 1048576))M"
              fi
              
              mtime=$(stat -c '%Y' "$item" 2>/dev/null || stat -f '%m' "$item" 2>/dev/null || echo 0)
              if [ "$mtime" -ne 0 ]; then
                date_str=$(date -d "@$mtime" '+%d-%b-%Y %H:%M' 2>/dev/null || date -r "$mtime" '+%d-%b-%Y %H:%M' 2>/dev/null || echo "-")
              else
                date_str="-"
              fi
              
              printf "%-50s %19s %s\n" "<a href=\"${name}\">${name}</a>" "$size" "$date_str" >> "${dir}/index.html"
            done
            
            cat >> "${dir}/index.html" <<'EOF'
</pre>
<hr>
</body>
</html>
EOF
          }
          
          # Generate indexes for APT repository structure
          # APT root directory
          [ -d "docs/apt" ] && generate_index "docs/apt"
          
          # Distribution directories (e.g., trixie)
          for dist in docs/apt/dists/*/; do
            [ -d "$dist" ] && [ "$(basename "$dist")" != "*" ] && generate_index "${dist%/}"
            
            # Component directories (e.g., main)
            for comp in "$dist"*/; do
              [ -d "$comp" ] && [ "$(basename "$comp")" != "*" ] && generate_index "${comp%/}"
              
              # Binary directories
              for bin in "$comp"binary-*/; do
                [ -d "$bin" ] && [ "$(basename "$bin")" != "*" ] && generate_index "${bin%/}"
              done
            done
          done
          
          # Pool directories
          if [ -d "docs/apt/pool" ]; then
            generate_index "docs/apt/pool"
            for comp in docs/apt/pool/*/; do
              [ -d "$comp" ] && [ "$(basename "$comp")" != "*" ] && generate_index "${comp%/}"
              
              # Package letter directories
              for letter in "$comp"*/; do
                [ -d "$letter" ] && [ "$(basename "$letter")" != "*" ] && generate_index "${letter%/}"
                
                # Package name directories  
                for pkg in "$letter"*/; do
                  [ -d "$pkg" ] && [ "$(basename "$pkg")" != "*" ] && generate_index "${pkg%/}"
                done
              done
            done
          fi

      - name: Commit and push to main branch
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Add and commit changes
          git add -A docs/
          git diff --staged --quiet || {
            git commit -m "ðŸš€ Update APT repository [$(date -u +%Y-%m-%d)]" 
            git push origin main
          } || echo "No changes to commit"
